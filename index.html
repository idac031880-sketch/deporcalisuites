<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Tarjetas ‚Äì Deportivo Cali (PWA Offline)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0B8F3B">

  <style>
    :root{
      --green:#0B8F3B; --green-900:#075C2A; --bg:#f5f7f6; --text:#0f172a;
      --card:#ffffff; --danger:#c1121f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    /* iPhone evita zoom en inputs */
    @supports (-webkit-touch-callout: none){
      input, select, textarea, button { font-size:16px; }
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:var(--bg); color:var(--text);
      overflow-x:hidden;             /* ‚Üê evita barra horizontal */
    }

    header{
      display:flex; align-items:center; gap:12px;
      padding:12px; background:linear-gradient(90deg,var(--green),var(--green-900));
      color:#fff; position:sticky; top:0; z-index:5;
    }
    header img{
      height:44px; width:auto; border-radius:8px; background:#fff; padding:4px;
      max-width:24vw;
    }
    .title{font-weight:800; line-height:1.1}

    .wrap{max-width:1100px; margin:14px auto; padding:0 10px}

    /* Toolbar responsive */
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; margin:8px 0}
    .toolbar input{flex:1 1 220px; min-width:0}

    button{
      background:var(--green); color:#fff; border:0; border-radius:10px;
      padding:10px 12px; font-weight:700; cursor:pointer;
    }
    button.secondary{background:#0c4a6e}
    button.ghost{background:#fff;color:var(--green);border:1px solid var(--green)}
    button.danger{background:var(--danger)}
    button:disabled{opacity:.55}

    input,select,textarea{
      width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; font-size:14px;
    }

    .card{
      background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:12px;
      box-shadow:0 2px 18px rgba(0,0,0,.03); margin-bottom:12px;
    }

    /* Grid: 1 columna en m√≥vil, 2 en desktop */
    .grid{display:grid; gap:12px}
    .grid.cols-2{grid-template-columns:1fr}
    @media (min-width:960px){ .grid.cols-2{grid-template-columns:1fr 1fr} }

    /* Tablas 100% fluidas y sin desborde */
    .table-wrap{width:100%}
    table{width:100%; border-collapse:collapse}
    th,td{
      padding:8px; border-bottom:1px dashed #e5e7eb; font-size:14px; text-align:left;
      word-break:break-word; white-space:normal;  /* ‚Üê envuelve texto largo */
    }
    th{font-size:12px; text-transform:uppercase; color:#475569}

    /* En pantallas MUY peque√±as, ocultamos algunas columnas para que quepa todo */
    @media (max-width: 420px){
      .col-cedula, .col-telefono, .col-partido { display:none; }
      th, td { font-size:13px; }
    }

    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#111827;color:#fff;padding:10px 12px;border-radius:10px;
      box-shadow:0 6px 24px rgba(0,0,0,.25);z-index:99;display:none}
    .toast.show{display:block}

    /* Scanner/V√≠deo dentro del ancho */
    #video{width:100%; height:auto; border-radius:12px; display:none; max-width:100vw}

    footer{color:#64748b; text-align:center; margin:20px 0}
  </style>
</head>
<body>
  <header>
    <img id="logo" src="icon-192.png" alt="Logo Deportivo Cali">
    <div>
      <div class="title">Control de Tarjetas ‚Äì Suites Deportivo Cali</div>
      <div class="muted" id="envNote"></div>
    </div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <button id="btnNuevoPartido">‚ûï Nuevo partido</button>
      <button id="btnAgregarTarjeta" class="secondary">‚ûï Tarjeta</button>
      <button id="btnEscanear" class="ghost">üì∑ Escanear</button>
      <input id="q" placeholder="Buscar por suite, c√≥digo o nombre‚Ä¶">
      <button id="btnExportCSV">‚¨áÔ∏è Exportar CSV</button>
      <button id="btnBackup" title="Copia de seguridad">üíæ Respaldo</button>
      <label class="ghost" style="border:1px solid #0B8F3B;border-radius:10px;padding:10px 12px;cursor:pointer;position:relative;overflow:hidden">üñºÔ∏è Subir logo
        <input id="logoFile" type="file" accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer">
      </label>
    </div>

    <div class="grid cols-2">
      <section class="card">
        <h2>Partido actual</h2>
        <div id="partidoActual" class="help"></div>
        <div style="margin-top:8px">
          <button id="btnCambiarPartido" class="ghost">Cambiar</button>
        </div>
      </section>

      <section class="card" id="scannerCard">
        <h2>Escanear / entrada manual</h2>
        <div class="help" id="scanSupport"></div>
        <div class="grid" style="margin-top:8px">
          <div><input id="manualCode" placeholder="C√≥digo de barras (manual)"></div>
          <div><input id="manualSuite" placeholder="Suite (ej. E-039)"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="btnStart">Iniciar c√°mara</button>
          <button id="btnStop" class="ghost">Detener</button>
          <button id="btnProcesarManual" class="secondary">Procesar</button>
        </div>
        <video id="video" playsinline autoplay muted></video>
      </section>
    </div>

    <section class="card">
      <h2>Pr√©stamos activos</h2>
      <div class="table-wrap">
        <table id="tblActivos">
          <thead><tr>
            <th class="col-fecha">Fecha entrega</th>
            <th class="col-suite">Suite</th>
            <th class="col-codigo">C√≥digo</th>
            <th class="col-nombre">Nombre</th>
            <th class="col-cedula">C√©dula</th>
            <th class="col-telefono">Tel√©fono</th>
            <th class="col-partido">Partido</th>
            <th class="col-acciones">Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Historial</h2>
      <div class="table-wrap">
        <table id="tblHistorial">
          <thead><tr>
            <th class="col-fecha">Fecha</th>
            <th class="col-suite">Suite</th>
            <th class="col-codigo">C√≥digo</th>
            <th class="col-nombre">Nombre</th>
            <th class="col-cedula">C√©dula</th>
            <th class="col-telefono">Tel√©fono</th>
            <th class="col-partido">Partido</th>
            <th class="col-estado">Estado</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer>PWA instalable. En iPhone abre por HTTPS y usa ‚ÄúA√±adir a pantalla de inicio‚Äù.</footer>
  </div>

  <!-- Modales -->
  <div class="modal" id="modalPartido"><div class="panel">
    <h3>Nuevo / Editar partido</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div style="flex:1"><label>Equipo local</label><input id="pLocal" value="Deportivo Cali"></div>
      <div style="flex:1"><label>Equipo visitante</label><input id="pVisitante" placeholder="Am√©rica, Junior, etc"></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <div style="flex:1"><label>Fecha</label><input id="pFecha" type="date"></div>
      <div style="flex:1"><label>Hora</label><input id="pHora" type="time"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="pGuardar">Guardar</button><button id="pCerrar" class="ghost">Cancelar</button>
    </div>
  </div></div>

  <div class="modal" id="modalTarjeta"><div class="panel">
    <h3>Agregar tarjeta</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div style="flex:1"><label>Suite</label><input id="tSuite" placeholder="E-039"></div>
      <div style="flex:1"><label>C√≥digo de barras</label><input id="tCodigo" placeholder="Escanea o escribe"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="tGuardar">Guardar</button><button id="tCerrar" class="ghost">Cerrar</button>
    </div>
  </div></div>

  <div class="modal" id="modalPrestar"><div class="panel">
    <h3 id="prestarTitle">Prestar tarjeta</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div style="flex:1"><label>Suite</label><input id="prSuite" readonly></div>
      <div style="flex:1"><label>C√≥digo</label><input id="prCodigo" readonly></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <div style="flex:1"><label>Nombre</label><input id="prNombre"></div>
      <div style="flex:1"><label>C√©dula</label><input id="prCedula"></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <div style="flex:1"><label>Tel√©fono</label><input id="prTelefono"></div>
      <div style="flex:1"><label>Partido</label><select id="prPartido"></select></div>
    </div>
    <div style="margin-top:8px"><label>Observaciones</label><textarea id="prObs" rows="2"></textarea></div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="prConfirmar">Confirmar pr√©stamo</button><button id="prCerrar" class="ghost">Cancelar</button>
    </div>
  </div></div>

  <div class="modal" id="modalConfirm"><div class="panel">
    <h3>Confirmar devoluci√≥n</h3>
    <p>¬øMarcar como devuelta la tarjeta <strong id="devSuite"></strong> (c√≥digo <strong id="devCodigo"></strong>)?</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="devOk">S√≠, devolver</button><button id="devCancel" class="ghost">Cancelar</button>
    </div>
  </div></div>

  <div id="toast" class="toast"></div>

<script>
/* Registrar Service Worker (PWA) */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}

(function(){
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200) }
  const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const load=(k,d)=>{try{const v=JSON.parse(localStorage.getItem(k)); return v??d}catch{return d}}
  const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,8);
  const fmt = iso => new Date(iso).toLocaleString();
  const nowISO = ()=> new Date().toISOString();

  const DB = {
    get cards(){return load('dcal_cards',[])}, set cards(v){save('dcal_cards',v)},
    get matches(){return load('dcal_matches',[])}, set matches(v){save('dcal_matches',v)},
    get loans(){return load('dcal_loans',[])}, set loans(v){save('dcal_loans',v)},
    get currentMatch(){const id=load('dcal_currentMatchId',null); return DB.matches.find(m=>m.id===id)||null},
    set currentMatchId(v){save('dcal_currentMatchId',v)},
    get logo(){return localStorage.getItem('dcal_logo')}, set logo(v){localStorage.setItem('dcal_logo',v)}
  };

  let stream=null, detector=null, running=false, rafId=null, lastScan='';

  function init(){
    const isFile = location.protocol === 'file:';
    $('#envNote').textContent = isFile ? 'Archivo local: la c√°mara puede NO funcionar.' : 'Origen seguro: c√°mara habilitada.';
    const lg = DB.logo; if(lg){ $('#logo').src = lg }

    if('BarcodeDetector' in window){
      try{ detector = new BarcodeDetector({formats:['code_128','code_39','ean_13','ean_8','upc_a','upc_e','qr_code']}); $('#scanSupport').textContent='Lector con c√°mara disponible.'; }
      catch{ $('#scanSupport').textContent='Lector con c√°mara no disponible; usa entrada manual.'; }
    } else {
      $('#scanSupport').textContent='Sin lector en vivo; usa entrada manual.';
    }

    byId('btnNuevoPartido', openPartido);
    byId('btnCambiarPartido', openPartido);
    byId('pGuardar', savePartido);
    byId('pCerrar', ()=>closeModal('#modalPartido'));

    byId('btnAgregarTarjeta', ()=>openTarjeta());
    byId('tGuardar', saveTarjeta);
    byId('tCerrar', ()=>closeModal('#modalTarjeta'));

    byId('btnStart', startCam);
    byId('btnStop', stopCam);
    byId('btnProcesarManual', processManual);

    byId('btnExportCSV', exportCSV);
    byId('btnBackup', backupJSON);

    $('#logoFile').addEventListener('change', onLogoUpload);

    byId('prConfirmar', confirmarPrestamo);
    byId('prCerrar', ()=>closeModal('#modalPrestar'));
    byId('devOk', doDevolver);
    byId('devCancel', ()=>closeModal('#modalConfirm'));

    $('#q').addEventListener('input', ()=>{ renderActivos(); renderHistorial(); });

    renderPartido(); renderActivos(); renderHistorial();
  }
  function byId(id,fn){ const el=document.getElementById(id); if(el) el.addEventListener('click', fn); }

  function renderPartido(){
    const m = DB.currentMatch; const el=$('#partidoActual');
    if(!m){ el.textContent='No hay partido seleccionado. Crea uno nuevo.'; return }
    const f=new Date(m.fecha).toLocaleDateString();
    el.innerHTML = `<strong>${m.local}</strong> vs <strong>${m.visitante}</strong> ‚Äî <span class="muted">${f} ${m.hora?('¬∑ '+m.hora):''}</span>`;
  }
  function renderActivos(){
    const q = $('#q').value.trim().toLowerCase(); const tb=$('#tblActivos tbody'); tb.innerHTML='';
    for(const l of DB.loans.filter(x=>!x.devueltoAt)){
      const c = DB.cards.find(x=>x.id===l.cardId)||{}; const m=DB.matches.find(x=>x.id===l.matchId)||{};
      const str = `${c.suite} ${c.codigo} ${l.nombre} ${l.cedula} ${l.telefono} ${(m.local||'')} ${(m.visitante||'')}`.toLowerCase(); if(q && !str.includes(q)) continue;
      const tr=document.createElement('tr'); tr.innerHTML=
        `<td class="col-fecha">${fmt(l.entregadoAt)}</td>
         <td class="col-suite"><strong>${c.suite||''}</strong></td>
         <td class="col-codigo">${c.codigo||''}</td>
         <td class="col-nombre">${l.nombre||''}</td>
         <td class="col-cedula">${l.cedula||''}</td>
         <td class="col-telefono">${l.telefono||''}</td>
         <td class="col-partido">${(m.local||'')} vs ${(m.visitante||'')}</td>
         <td class="col-acciones"><button class="ghost devol" data-id="${l.id}">Devolver</button></td>`;
      tb.appendChild(tr);
    }
    $$('.devol').forEach(b=>b.addEventListener('click',()=>confirmDevolver(b.dataset.id)));
  }
  function renderHistorial(){
    const q = $('#q').value.trim().toLowerCase(); const tb=$('#tblHistorial tbody'); tb.innerHTML='';
    for(const l of [...DB.loans].sort((a,b)=>new Date(b.entregadoAt)-new Date(a.entregadoAt))){
      const c=DB.cards.find(x=>x.id===l.cardId)||{}; const m=DB.matches.find(x=>x.id===l.matchId)||{};
      const estado=l.devueltoAt?'<span class="pill" style="background:#ecfeff;border:1px solid #99f6e4;color:#0f766e;padding:.15rem .5rem;border-radius:999px;font-size:12px;font-weight:700">Devuelto</span>':'<span class="pill" style="background:#fff0f1;border:1px solid #fecdd3;color:#9f1239;padding:.15rem .5rem;border-radius:999px;font-size:12px;font-weight:700">Prestado</span>';
      const str=`${c.suite} ${c.codigo} ${l.nombre} ${l.cedula} ${l.telefono} ${(m.local||'')} ${(m.visitante||'')}`.toLowerCase(); if(q && !str.includes(q)) continue;
      const tr=document.createElement('tr'); tr.innerHTML=
        `<td class="col-fecha">${fmt(l.entregadoAt)}${l.devueltoAt?('<br><span class="muted">‚á¢ '+fmt(l.devueltoAt)+'</span>'):''}</td>
         <td class="col-suite"><strong>${c.suite||''}</strong></td>
         <td class="col-codigo">${c.codigo||''}</td>
         <td class="col-nombre">${l.nombre||''}</td>
         <td class="col-cedula">${l.cedula||''}</td>
         <td class="col-telefono">${l.telefono||''}</td>
         <td class="col-partido">${(m.local||'')} vs ${(m.visitante||'')}</td>
         <td class="col-estado">${estado}</td>`;
      tb.appendChild(tr);
    }
  }

  // Partidos
  function openPartido(){ const m=DB.currentMatch; $('#pLocal').value=m?.local||'Deportivo Cali'; $('#pVisitante').value=m?.visitante||''; $('#pFecha').valueAsDate = m?.fecha?new Date(m.fecha):new Date(); $('#pHora').value=m?.hora||''; openModal('#modalPartido') }
  function savePartido(){ const local=$('#pLocal').value.trim()||'Deportivo Cali'; const visitante=$('#pVisitante').value.trim()||'‚Äî'; const fecha=$('#pFecha').value?new Date($('#pFecha').value).toISOString():nowISO(); const hora=$('#pHora').value||''; const curr=DB.currentMatch; if(curr){ Object.assign(curr,{local,visitante,fecha,hora}); DB.matches = DB.matches.map(x=>x.id===curr.id?curr:x); } else { const id=uid(); const m={id,local,visitante,fecha,hora}; DB.matches=[...DB.matches,m]; DB.currentMatchId=id; } renderPartido(); loadPartidosSelect(); closeModal('#modalPartido') }
  function loadPartidosSelect(){ const sel=$('#prPartido'); sel.innerHTML=''; for(const m of DB.matches){ const o=document.createElement('option'); o.value=m.id; o.textContent=`${m.local} vs ${m.visitante} (${new Date(m.fecha).toLocaleDateString()})`; sel.appendChild(o) } if(DB.currentMatch) sel.value=DB.currentMatch.id }

  // Tarjetas
  function openTarjeta(suite='',codigo=''){ $('#tSuite').value=suite; $('#tCodigo').value=codigo; openModal('#modalTarjeta') }
  function saveTarjeta(){ const suite=$('#tSuite').value.trim(); const codigo=$('#tCodigo').value.trim(); if(!suite||!codigo){toast('Suite y c√≥digo son obligatorios');return} let card = DB.cards.find(c=>c.codigo===codigo || c.suite.toLowerCase()===suite.toLowerCase()); if(card){ card.suite=suite; card.codigo=codigo; DB.cards = DB.cards.map(x=>x.id===card.id?card:x) } else { DB.cards=[...DB.cards,{id:uid(),suite,codigo}] } closeModal('#modalTarjeta') }

  // Pr√©stamos / Devoluci√≥n
  let pendingCard=null, pendingLoanId=null;
  function openPrestar(card){ pendingCard=card; $('#prestarTitle').textContent='Prestar tarjeta'; $('#prSuite').value=card.suite; $('#prCodigo').value=card.codigo; $('#prNombre').value=''; $('#prCedula').value=''; $('#prTelefono').value=''; $('#prObs').value=''; loadPartidosSelect(); openModal('#modalPrestar') }
  function confirmarPrestamo(){ if(!pendingCard) return; const nombre=$('#prNombre').value.trim(); const cedula=$('#prCedula').value.trim(); const telefono=$('#prTelefono').value.trim(); if(!nombre||!cedula){toast('Nombre y c√©dula son obligatorios');return} const matchId=$('#prPartido').value || (DB.currentMatch?.id??null); const loan={id:uid(), cardId: pendingCard.id, matchId, nombre, cedula, telefono, obs:$('#prObs').value.trim(), entregadoAt: nowISO(), devueltoAt:null}; DB.loans=[loan, ...DB.loans]; renderActivos(); renderHistorial(); toast('Pr√©stamo registrado'); closeModal('#modalPrestar') }
  function confirmDevolver(id){ const l=DB.loans.find(x=>x.id===id); if(!l) return; const c=DB.cards.find(x=>x.id===l.cardId)||{suite:'?',codigo:'?'}; pendingLoanId=id; $('#devSuite').textContent=c.suite; $('#devCodigo').textContent=c.codigo; openModal('#modalConfirm') }
  function doDevolver(){ if(!pendingLoanId) return; DB.loans = DB.loans.map(l=> l.id===pendingLoanId ? {...l, devueltoAt: nowISO()} : l); renderActivos(); renderHistorial(); toast('Devoluci√≥n registrada'); closeModal('#modalConfirm') }

  // Scanner
  async function startCam(){ try{ if(running) return; if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){ toast('C√°mara no soportada'); return } stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); const v=$('#video'); v.srcObject=stream; await v.play(); v.style.display='block'; running=true; lastScan=''; if('BarcodeDetector' in window && detector){ scanLoop(); } else { toast('C√°mara encendida (sin lector); usa entrada manual.')} } catch(e){ toast('No se pudo acceder a la c√°mara') } }
  function stopCam(){ running=false; if(rafId) cancelAnimationFrame(rafId); const v=$('#video'); if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null } v.removeAttribute('srcObject'); v.style.display='none' }
  async function scanLoop(){ if(!running||!detector) return; try{ const codes = await detector.detect($('#video')); if(codes && codes.length){ const val=(codes[0].rawValue||'').trim(); if(val && val!==lastScan){ lastScan=val; handleScan(val,null) } } }catch(e){} rafId = requestAnimationFrame(scanLoop) }

  function processManual(){ const code=$('#manualCode').value.trim(); const suite=$('#manualSuite').value.trim(); if(!code && !suite){ toast('Ingresa el c√≥digo o la suite'); return } handleScan(code||null, suite||null) }
  function handleScan(code,suite){ let card=null; if(code){ card=DB.cards.find(c=>c.codigo===code) } if(!card && suite){ card=DB.cards.find(c=>c.suite.toLowerCase()===suite.toLowerCase()) } if(!card){ if(!suite){ const s=prompt('Tarjeta no registrada. Escribe la suite para asociar:','E-'); if(!s) return; suite=s.trim() } if(!code){ const c=prompt('C√≥digo de barras (o deja vac√≠o):',''); if(c) code=c.trim() } openTarjeta(suite||'', code||''); return } const activo = DB.loans.find(l=>l.cardId===card.id && !l.devueltoAt); if(activo){ confirmDevolver(activo.id) } else { openPrestar(card) } }

  // Exportar / Respaldo
  function exportCSV(){ const rows=[['Fecha entrega','Fecha devoluci√≥n','Suite','C√≥digo','Nombre','C√©dula','Tel√©fono','Partido','Observaciones']]; for(const l of DB.loans){ const c=DB.cards.find(x=>x.id===l.cardId)||{}; const m=DB.matches.find(x=>x.id===l.matchId)||{}; rows.push([ l.entregadoAt?new Date(l.entregadoAt).toLocaleString():'', l.devueltoAt?new Date(l.devueltoAt).toLocaleString():'', c.suite||'', c.codigo||'', l.nombre||'', l.cedula||'', l.telefono||'', `${m.local||''} vs ${m.visitante||''}`, l.obs||'' ]) } const csv = rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join('\n'===0)).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='prestamos_suites.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); toast('CSV generado') }
  function backupJSON(){ const data={cards:DB.cards,matches:DB.matches,loans:DB.loans,currentMatchId:load('dcal_currentMatchId',null)}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup_suites.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); toast('Respaldo descargado') }

  // Logo
  function onLogoUpload(e){ const f=e.target.files && e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ DB.logo=fr.result; $('#logo').src=DB.logo; toast('Logo guardado') }; fr.readAsDataURL(f); e.target.value='' }

  // Modales
  function openModal(sel){ document.querySelector(sel).classList.add('open') }
  function closeModal(sel){ document.querySelector(sel).classList.remove('open') }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
